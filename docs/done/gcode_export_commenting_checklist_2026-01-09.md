# どこで: `docs/plan/gcode_export_commenting_checklist_2026-01-09.md`。

# 何を: `src/grafix/export/gcode.py` の可読性向上（詳細コメント追加）の作業計画（チェックリスト）をまとめる。

# なぜ: 実装済みの G-code 生成ロジック（紙クリップ/座標変換/ベッド検証/近接連結）を、後から安全に理解・変更できる状態にするため。

# gcode.py コメント追加チェックリスト（2026-01-09）

## 0. 前提

- 対象ファイル: `src/grafix/export/gcode.py`
- 目的は「動作の理解補助」であり、挙動変更はしない（コメントと必要最小限の命名/整形のみ）。
- コメント方針:
  - What/How はコードと型で表現しつつ、分岐の意図やアルゴリズム名など「読み手が迷う点」をコメントで補足する。
  - 仕様（紙安全化・ベッド検証・近接連結）の順序関係が誤解されやすい箇所は、処理順を明記する。

## 1. コメントを厚くする対象

- [x] 1. `_fmt_float()`
  - [x] `-0.000` 正規化の意図（決定的出力 / 文字列比較テスト向け）をコメント
- [x] 2. `_clip_segment_to_rect()`
  - [x] クリップ手法（Liang–Barsky）と、`u1/u2` の意味をコメント
  - [x] `eps` の役割（ゼロ割/極短線分の扱い）をコメント
- [x] 3. `_clip_polyline_to_rect()`
  - [x] 「線分単位でクリップ → 連続部分をまとめて複数ポリラインに分割」の方針をコメント
  - [x] `current` を flush する条件（紙外へ出る、断絶が起きた）をコメント
  - [x] `force_travel`（紙外区間は必ずペンアップ移動）の前提に繋がる点をコメント
- [x] 4. `_paper_safe_rect()`
  - [x] `paper_margin_mm` の意味と、`2*m >= w/h` を弾く理由をコメント
- [x] 5. `_canvas_to_machine_xy()`
  - [x] 座標変換の順序（y反転→origin）と、`canvas_height_mm` の扱い（未指定時は canvas_size の高さを使う）をコメント
- [x] 6. `_validate_bed_xy()`
  - [x] 「入力頂点ではなく、実際に出力する G1(XY) だけを検証する」安全設計をコメント
- [x] 7. `export_gcode()`
  - [x] パイプライン順序（紙クリップ → 近接連結/分断判定 → 座標変換/丸め → bed 検証 → G-code 行生成）をブロックコメントで明記
  - [x] Z/Feed の切替規約（travel/draw の意味、いつ Z up/down を出すか）をコメント
  - [x] `prev_last_in_layer` をレイヤ境界でリセットする理由（事故線防止）をコメント
  - [x] 近接連結の「適用しない」条件（紙クリップ分断）をコメント

## 2. 追加で確認したいこと（必要なら追記）

- [x] コメント量は「読みやすさ優先」でよいか（長文化しすぎない範囲で）；はい
- [x] コメントは日本語で統一してよいか（本リポジトリの方針に合わせる）；はい
