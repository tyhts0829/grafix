# どこで: `src/grafix/core/primitives/text.py`

#

# 何を: テキストプリミティブに「バウンディングボックス（幅指定による自動改行）+ デバッグ表示」を追加する。

#

# なぜ: 文章ブロックをレイアウトするときに、指定幅からはみ出さないように自動で改行したい（下方向にはみ出るぶんは許容）。

作成日: 2026-01-19

## ゴール

- `G.text(...)` にボックスサイズを渡すと、**幅**からはみ出るぶんを自動改行する。
  - 明示改行（`\\n`）は維持し、各行をさらに折り返す。
  - 改行して **下方向へはみ出す**ぶんは OK（高さでの打ち切り/クリップはしない）。
- `show_bounding_box=True` のとき、指定サイズのボックス枠を一緒に描画できる。

## 非ゴール（今回やらない）

- カーニング/高度な字詰め（glyph outline の正確な見た目幅での行分割など）。
- ハイフネーション、禁則処理。
- `box_height` を使ったクリップ、ページング。
- 縦方向のアライメント仕様変更（現状の `y=0` 基準は維持）。

## 仕様（提案）

### 追加する引数（案）

`src/grafix/core/primitives/text.py:text()` に以下を追加する。

- `box_width: float = -1.0`
- `box_height: float = -1.0`
- `show_bounding_box: bool = False`

解釈:

- `box_width > 0` のときだけ「幅による折り返し」を有効化する。
- `show_bounding_box=True` のときは `box_width>0` かつ `box_height>0` を前提に枠線を描く。
- 単位は **出力座標系（= `scale` 適用後）** とし、内部では `box_width_em = box_width / abs(scale)` に変換して折り返し判定する（`scale=0` の場合は無効）。

### ボックスの基準位置（暫定）

- 横方向: 既存の `text_align` に合わせてボックスを配置する。
  - `left`: x ∈ `[0, box_width]`
  - `center`: x ∈ `[-box_width/2, box_width/2]`
  - `right`: x ∈ `[-box_width, 0]`
- 縦方向: 現状のテキスト生成が「1 行目のベースラインが y=0」なので、ボックスも暫定で `y=0` を上辺として `y ∈ [0, box_height]` とする。
  - ここは直感とズレる可能性があるので、必要なら **フォントの ascent を使って上辺を `-ascent` に置く**案も検討（要確認）。

### 折り返しルール（暫定）

- 基本は **貪欲法**（左から順に、次の 1 文字を足すと `box_width` を超えるなら改行）。
- 空白がある場合は「直近の空白で折る」を優先（なければ文字単位で折る）。
- 行頭の空白は落とす（折り返し直後に先頭が `" "` になるのを避ける）。
- `box_width` が極端に小さくても無限ループしない（1 文字だけの行は許容）。

## 実装チェックリスト

- [x] `text_meta` に `box_width / box_height / show_bounding_box` を追加（UI で触れるようにする）
- [x] `text()` の冒頭で `box_width_em` を計算（`scale<=0` での扱いを決める）
- [x] 折り返し用の小関数を追加（例: `_wrap_lines_by_width(...)`）
  - [x] 明示改行を維持しつつ折り返し適用
  - [x] 空白優先折り返し + フォールバック文字折り
- [x] 描画ループを「折り返し後の lines」に対して実行するように変更
- [x] `show_bounding_box=True` のとき、ボックス枠の線分（4 本）を追加
  - [x] 枠は塗り潰し誤爆を避けるため、閉ポリライン 1 本ではなく「4 本の線分」にする
- [x] docstring に追加引数と単位/挙動を追記
- [x] テスト追加
  - [x] `box_width` 指定で Y 方向の extent が増える（=折り返しが起きている）こと
  - [x] `show_bounding_box=True` でポリライン本数が +4 されること（テキスト空でも確認）
- [x] `PYTHONPATH=src pytest -q`（必要なら該当テストに絞って実行）

## 要確認（あなたに決めてほしい点）

1. `box_width/box_height` の単位は「出力座標系（scale 後）」で OK？；出力座標系でいい。
2. ボックスの縦位置: `y=0` 上辺のままで良い？ それとも `-ascent` を上辺にする方が直感に合う？；y=0 が上辺でいい。
3. 折り返し: 「空白優先 + 文字フォールバック」で OK？（日本語も想定して文字単位は残す）；OK

## 変更対象（想定）

- `src/grafix/core/primitives/text.py`
- `tests/core/test_text_primitive.py`（新規テスト追加 or 近接ファイルに追加）
