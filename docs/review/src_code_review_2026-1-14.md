問題点:
パラメータ処理の分散と若干の関心事混在: パラメータ GUI やスタイル上書きに関する処理ロジックが複数箇所に点在し、将来的な仕様変更時に修正漏れのリスクがあります。例えば Layer のスタイル名ラベル設定や UI 値適用処理が pipeline.realize_scene 内に直接記述されていますが、これは描画パイプラインと UI ロジックの混在につながっています。同様にプリセットや Primitive/Effect 生成時にもラベル付け・パラメータ解決処理があり、実装が横断的です。現在 \_param_resolution で重複削減されていますが、それでも UI 関連処理が各所に現れるため、コードの見通しをやや悪くしています。
グローバル状態の多用とそれに伴う保守リスク: 設計上グローバルなシングルトンやキャッシュを多用しており、依存関係が暗黙になりがちです。例えば Geometry 実体化の RealizeCache はグローバルかつプロセス全体で共有され、clear も上限もありません。長時間実行で GeometryId が増え続けた場合、キャッシュが際限なく肥大化する懸念があります（※コメント上でも将来の上限検討事項とされています）。また grafix.cc のように現在の CC 値をグローバル参照するオブジェクトを提供していますが、これもコンテキスト外ではデフォルト値を返す特殊挙動であり、使用側コードから見ると隠れた依存になります。同様に runtime_config 等の設定読み出しも暗黙のシングルトン実装で、モジュール間の結合度が高いです。これらのグローバル依存はテストや複数インスタンス利用の妨げにもなりえます。
マルチプロセス時の重複計算と設計複雑さ: 現在、描画処理の並列化（mp-draw）に対応していますが、プロセス間でキャッシュ共有がされないためワーカー側とメイン側で Geometry 評価の重複が発生しうる点が懸念されます。実際、ワーカープロセスで生成したシーンをメインプロセスで再度 realize_scene している実装が見られ、並列化の効果が一部相殺されている可能性があります。またこの並列描画の実装（シーン実行・結果マージ・例外ハンドリングなど）はかなり高度で、システム全体の理解難易度を上げています。保守の観点では、バグ発生時にプロセス間の挙動を追うのが難しい複雑さがあります。
API デザイン上の一部懸念: 公開 API のシングルトン（G, E, L など）について、名前が極めて短くグローバルに定義されているため、利用者コードの変数と衝突したり可読性を損ねたりする恐れがあります。短い名前自体はタイプ量削減に有効ですが、コードレビューの観点では明示性に欠ける部分です。また EffectBuilder は不変データクラスで都度新インスタンスを返す実装ですが、各チェーンステップ追加のたびに毎回 effect_registry からメタ情報を取得しており、効率面ではわずかに無駄があります。ステップ数が多い場合に同一データの繰り返し取得・解決を行っている点はエレガントさを損ねるポイントです。
推奨改善案:
パラメータ観測処理のモジュール化: Layer スタイルの GUI 上書き適用やラベル設定処理は、描画パイプラインから切り離し専用モジュールないし関数に委譲することを検討してください。例えば apply_layer_overrides(resolved_layer, store) のような関数に抽出し、そこで ParamStore のチェックと上書きを行う形にすれば、パイプラインコードが簡潔になり関心事分離も向上します。こうした集約により、将来パラメータ仕様を変更しても修正箇所を一か所に留められ、保守性が高まります。
キャッシュの制御機構導入: realize_cache に対して明示的なクリア操作やサイズ上限の設定を追加することを強く推奨します。例えば一定以上エントリが増えたら古い項目を削除する LRU ポリシーや、ユーザが不要時にキャッシュをリセットできる API を提供すると、安全に長時間実行できます。また、もしワーカーとメインでキャッシュ共有が必要であれば、将来的にはプロセス間共有メモリやマルチプロセス用のキャッシュ戦略を検討してください（実装コストと見合いになりますが、少なくともドキュメントで「並列時はキャッシュ効果が限定的」等の注意喚起はあると良いでしょう）。
グローバル依存の明示化と削減: cc や設定オブジェクトなどのグローバル状態は、可能であればシングルトンオブジェクトにカプセル化し注入可能な形に改良できます。例えば runtime_config を単純な関数ではなく設定クラスのインスタンスとして扱い、必要箇所で明示的に渡す/参照するようにすれば、依存関係がコード上表現され追跡しやすくなります。同様に cc も内部で current_cc_snapshot() を呼ぶのではなく、例えば ParamStore から取得する仕組みに変えるなど、グローバル関数呼び出しを減らす方向で検討してください。これによりテスト容易性も上がり、思わぬ副作用の排除に繋がります。
API 利便性と可読性の両立: エンドユーザ向け API のデザインは簡潔さと明示性のトレードオフがあります。現状の G, E, L といったシングルトンをそのまま公開するアプローチは便利な反面衝突リスクもあるため、例えば import grafix.api as gfx のように名前空間経由で使う想定をより強調するか、別名エイリアスを提供することも検討に値します。また、EffectBuilder 内で頻繁に呼ばれるメタ情報取得については、一度計算した defaults/meta を EffectBuilder.steps 内に保持して繰り返し利用するキャッシュを導入するとわずかながら効率とコードの洗練性が向上します。現状性能上致命的問題ではありませんが、ステップ数増大時の冗長計算を防ぐ改善として検討してください。
複雑機能の段階的改善: マルチプロセス描画やパラメータ GUI 統合など高度な機能は、動作とコードフローが複雑です。今後の保守では、例えばログ出力やデバッグモードを充実させて挙動を追跡しやすくしたり、ドキュメントに内部フロー図を追加するなどして、開発者が理解しやすい工夫が望まれます。機能面では既に充実していますので、今後は複雑さの管理を重視し、必要に応じてリファクタリングや構造の見直しを行うことで、将来の拡張に備えると良いでしょう。
